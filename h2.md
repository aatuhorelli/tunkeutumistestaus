# H2 - Scanning Cyberspace

Tehtävänannot luettavissa https://terokarvinen.com/2024/eettinen-hakkerointi-2024/.

Tehtävien suorittamiseen käytetyn laitteen perustiedot:

    OS: Kali Linux 2023.4
    RAM: 16GB
    CPU: 12th Gen Intel(R) Core(TM) i7-1255u (x86_64)

## X) Tiivistelmät

### Lyon 2009: Nmap Network Scanning: Chapter 15. Nmap Reference Guide: 


#### Port Scanning Basics

 - ``$ nmap <kohdeosoite>`` skannaa kohteesta 1000 TCP-porttia.
 - Nmap jakaa portit kuuteen skannauksen tuloksen perusteella kuuteen eri tilaan:
   - Open: Portissa sovellus hyväksyy TCP-yhteyksiä, UDP-datagrammeja tai SCTP-yhtymiä. Näiden löytäminen usein skannauksen ensisijainen tarkoitus. Avoimia portteja pyritään sulkemaan, sillä hyökkäykset kohdistuvat yleensä näihin. Paljastavat myös mitä palveluita verkossa pyörii. 
   - Closed: Portti vastaa Nmapin paketteihin, mutta mikään sovellus ei kuuntele sitä. Paljastaa kohdeosoitteen vastaavan pyyntöihin ja voidaan osaltaan hyödyntää käyttöjärjestelmäskannaukseen. Closed-tilassa olevat portit kannataa skannata myöhemmin uudelleen siltä varalta, että se on avattu.
   - Filtered: Nmap ei kykene päättelemään portin avoimuutta. Palomuuri(verkon tai kohdelaitteen oma) tai reitittimen säännöt estävät pakettien pääsyn porttiin. Vastaus saattaa tulla ICMP-virheviestinä, mutta useimmiten nmapin paketit vain hylätään, mistä johtuen skannaus hidastuu Nmapin lähettäessä useita tiedustelupaketteja samaan porttiin. 
   - Unfiltered: Portti on saatavilla, mutta Nmap ei pysty päättelemään onko se auki vai kiinni. Vain ACK-skannauksessa mahdollinen lopputulos. Lisäskannaus muilla ohjelmilla(Window-/SYN-/FIN scan) saattaa antaa paremman ymmärryksen portin avoimuudesta. 
   - Open/filtered: Nmap ei pysty päättelemään, onko portti auki vai kiinni, jos portti ei vastaa. Voi johtua tiedustelupaketin tai lähetetyn vastauksen suodattumisesta. UDP/IP protocol/FIN/NULL/XMAS-skannien tapa luokitella portteja.
   - Closed/filtered: IP ID idle skannin mahdollinen tulos. Nmap ei onnistu päättelemään, onko portti auki vai kiinni. 

Lähde: https://nmap.org/book/man-port-scanning-basics.html

#### Port Scanning Techniques

 - Onnistuneessa porttiskannauksessa on kyse siitä, että osaa käyttää oikeita tekniikoita ja välineitä tiettyyn tarkoitukseen
 - Monet skannaukset ovat mahdollista vain pääkäyttäjäoikeuksin, sillä ne lähettävät root-oikeuksia vaativia raw-paketteja.
 - Nmapin tulokset ovat tulkintoja kohdejärjestelmien lähettämistä vastauksista, eivätkä siten ole aina luotettavia.
 - Erilaisia skannauksia. Käytettävissä vain yhtä kerrallaan (pl. UDP- ja SCTP-skannaukset):
   - ``-sS``: TCP SYN -skannaus. Yleisin ja suosituin skannaustyyppi. Skannaa tuhansia portteja sekunnissa, jos verkon nopeus tai palomuuri eivät toimi hidasteina. Melko huomaamaton, sillä se jättää TCP-yhteyden muodostamisen kesken(half-open scanning). Tunnistaa open/close/filtered-tilat. Lähettää SYN-paketin, johon saatu SYN tai SYN/ACK-vastaus viittaa avoimeen porttiin. RST(reset) viittaa siihen, että kohdejärjestelmä ei kuuntele porttia. ICMP unreachable error -> filtered-tila.
   - ``-sT``: TCP Connect scan. Käytetään, jos huomaamattomampi ja nopeampi SYN-skannaus ei ole käytettävissä esimerkiksi vaillinaisten käyttöoikeuksien johdosta. Luo yhteyksiä kohdejärjestelmään connect-kutsulla(käytössä useimmissa verkkosovelluksissa, esim. web-selaimet ja P2P-clientit). Näistä jää kohdejärjestelmän lokiin merkintöjä. Lukee vastaukset Berkeley Sockets API -rajapinnasta. 
   - ``--sU``: UDP-skannaus. Yhdistettävissä esim. SYN-skannaukseen. UDP-skannaus yleisesti ottaen hitaampaa ja vaikeampaa kuin TCP-skannaus, joten saatetaan jättää myös puolustajalta huomiotta. Hitaus johtuu siitä, että paketteihin harvoin lähetetään vastauksia avoimista porteista. Lähettää tyhjän UDP-paketin jokaiseen kohdeporttiin ilman ``--data``. ``--data-string`` tai ``--data-length`` käyttöä, mutta yleisimpiin portteihin(53, 161/162 ja 67/68 (DNS, SNMP, DHCP))lähteviin paketteihin liitetään aina hyötykuorma vastauksen nopeuttamiseksi. Vastaukset:
     - ICMP port unreachable (type 3, code 3) = closed
     - (type 3, code 0, 1, 2, 9, 10, 13) = filtered
     - Palvelu vastaa UDP-paketilla = open
     - Ei vastausta = open|filtered. Versiontunnistus ``-sV`` saattaa auttaa tunnistamaan, onko tällainen portti auki. 
  
Lähde: https://nmap.org/book/man-port-scanning-techniques.html

### KKO 2003:36

 - Alaikäinen(17v.) porttiskannasi Osuuspankkikeskus-OPK:n tietojärjeslmän kaikki osoitteet löytääkseen avoimia välityspalvelimia.
 - Tekijä oli aiemminkin tehnyt porttiskannauksia kokeilumielessä, eikä ollut tapauksessa tietoinen siitä, että skannattava verkko kuului osuuskunnalle.
 - Oikeus katsoi, että skannaus tehtiin tietomurtotarkoituksessa, vaikka tekijä ei onnistunut tunkeutumaan tietojärjestelmään.
 - Tuomio: sakkorangaistus ja 75000mk vahingonkorvaukset
   - Korkein oikeus ei muuttanut tuomiota.

Lähde: https://finlex.fi/fi/oikeus/kko/kko/2003/20030036


## A, B & C) Kali & Metasploitable2 -virtuaalikoneiden asennus host-only-verkkoon


### Alkuvirittelyt 

Olen aiemmilla kursseilla käyttänyt Vagrantia virtuaalikoneiden provisiointiin. Vagrantin avulla virtuaalikoneiden asennus on huomattavasti nopeampaa kuin manuaalisesti. Ajattelin yhdistää kolme ensimmäistä tehtävää, ja virtualisoida asentaa molemmat koneet samalla kertaa, niille host-only verkko samalla määrittäen.

Aloitin tarkistamalla, että virtualisoinnissa tarvittavat Vagrant ja VirtualBox on asennettu ajamalla komennot ``$ vagrant`` ja ``$ virtualbox``. Ensimmäinen komento tulosti vagrantin ohjeet ja toinen käynnisti VirtualBoxin, joten molemmat olivat jo asennettuja. Seuraavaksi loin kotihakemistooni kansion (``$ mkdir /home/aatu/vagrant/metakali/``) Vagrantin VagrantFilelle, johon määrittelisin virtualisoitavien koneiden tiedot. 

Loin VagrantFilen pohjan ajamalla hakemistossa komennon ``$ vagrant init``. VagrantFile luotiin, ja siirryin muokkaamaan sitä komennolla ``$ micro VagrantFile``. Muokkasin aluksi tiedostoa poistamalla kommentit ja vaihtamalla asennettavan virtuaalikoneen paketin tehtävänannoin vinkkiosion mukaisesti kohdasta ``config.vm.box = "kalilinux/rolling"`` testatakseni, että se käynnistyy sellaisenaan ja myöhemmät ongelmat olisivat todennäköisesti itsestäni johtuvia. 

    $ cat Vagrantfile 
    # -*- mode: ruby -*-
    # vi: set ft=ruby :
    Vagrant.configure("2") do |config|
      config.vm.box = "kalilinux/rolling"
    end

Tiedoston tallennus ctrl+S ja sulkeminen ctrl+Q, minkä jälkeen testasin koneen asennusta ja käynnistystä komennolla ``$ vagrant up``. Tämä latasi pakettia hetken, minkä jälkeen käynnisti VirtualBoxin ikkunaan Kalin. Asennus siis onnistui, ja käyttäjätunnus-salasana-yhdistelmä vagrant/vagrant meni kerrasta oikein. Testasin vielä virtuaalikoneella, löytyykö internetyhteys.

![Add file: vagrant kali](/img/h2/vagrant_kali1.png)
> Ensimmäinen yritys Kalin asennuksesta onnistunut

Lopuksi poistin koneen komennolla ``$ vagrant destroy`` siirtyäkseni testaamaan samalla tiedostolla Metasploitable 2:n asennusta. Muokkasin VagrantFilen ``$ micro VagrantFile`` -> (ctrl+S -> ctrl+Q):

````
# -*- mode: ruby -*-
# vi: set ft=ruby :
Vagrant.configure("2") do |config|
  config.vm.box = "Sliim/metasploitable2" # tätä muokattu edellisestä
end
````
Tämän jälkeen käynnistin koneen komennolla ``$ vagrant up``. Asennus jäi lopuksi tulostamaan loputtomasti rivejä ``default: Warning: Authentication failure. Retrying...``. Tapoin prosessin painamalla terminaalissa ctrl+C, ja tarkastin onko asennettu virtuaalikone päällä:

````
$ vagrant status
Current machine states:

default                   running (virtualbox)

The VM is running. To stop this VM, you can run `vagrant halt` to
shut it down forcefully, or you can run `vagrant suspend` to simply
suspend the virtual machine. In either case, to restart it again,
simply run `vagrant up`.
````

Päällä oli, mutta SSH:lla ei voida muodostaa yhteyttä. Epäilin tämän olevan tarkoituksellista, ja tarkistin asian tarkastamalla Virtualboxin kautta Metasploitablen avaamalla, missä portissa SSH on toiminnassa. Vagrant yhdistää SSH:lla vakiona porttiin 2222. Löysin [Redditistä](https://www.reddit.com/r/HowToHack/comments/10kmmqu/dose_metasplotable2_have_an_equivalent_to_sudo/?rdt=36604) keskustelun, josta löytämääni komentoa ``$ ps aux | grep ssh`` käyttämällä totesin SSH:n kuuntelevan portteja 3941 ja 6495. Ei siis ongelmaa asennuksessa, voidaan siirtyä eteenpäin!

![Add file: meta ssh-portit](/img/h2/vagrant_meta_ssh_portit.png)
> Metasploitablen kuuntelemat SSH-portit

### Kalin ja Metasploitablen asennus samanaikaisesti

Tarkoituksena oli määritellä VagrantFile siten, että se lataa ja asentaa Kali Linuxin sekä Metasploitablen, ja luo näiden välille host-only-verkon. Päätin samalla selvittää, miten saan Kalin määriteltyä siten, että sillä on tarvittaessa myös internet-yhteys. 

Muokkasin aiemminkin hyödyntämääni [Tero Karvisen pohjaa](https://terokarvinen.com/2023/salt-vagrant/). Testasin alkuun vain host-only-verkon luomista, mutta siitä huolimatta koneet karkasivat internetiin. VagrantFilen sisältö tässä vaiheessa:

````
# -*- mode: ruby -*-
# vi: set ft=ruby :
Vagrant.configure("2") do |config|

        config.vm.define "kali" do |kali|
            kali.vm.box = "kalilinux/rolling"
            kali.vm.network "private_network", ip: "192.168.57.101"
            kali.vm.hostname = "kali"
        end

        config.vm.define "meta" do |meta|
            meta.vm.box = "Sliim/metasploitable2"
            meta.vm.network "private_network", ip: "192.168.57.102"
            meta.vm.hostname = "meta"
        end
end
````

## Lähteet

Lyon 2009: Nmap Network Scanning: Chapter 15. Nmap Reference Guide. Luettavissa: https://nmap.org/book/man-port-scanning-basics.html. Luettu 13.4.2024
